function getDateString(e){var r=""+e.getFullYear(),t=e.getMonth()+1<10?"0"+(e.getMonth()+1):""+(e.getMonth()+1),a=e.getDate()<10?"0"+e.getDate():""+e.getDate(),n=a+t+r;return n}function getDescriptiveDateString(e){return e.getDate()+" "+monthNames[e.getMonth()]+" "+e.getFullYear()}var express=require("express"),routes=require("./routes"),http=require("http"),path=require("path"),crypto=require("crypto"),Db=require("mongodb").Db,Connection=require("mongodb").Connection,Server=require("mongodb").Server,InitService=require("./routes/InitService.min").InitService;ManufactureService=require("./routes/ManufacturerService.min").ManufacturerService,ModelService=require("./routes/ModelService.min").ModelService,ServiceTypeService=require("./routes/ServiceTypeService.min").ServiceTypeService,JobService=require("./routes/JobService.min").JobService,manualService=require("./routes/ManualService.min").ManualService,taskService=require("./routes/TaskService.min").TaskService,idGenerationService=require("./routes/IDGenerationService.min").IDGenerationService,jobcardService=require("./routes/JobCardService.min").JobCardService,partService=require("./routes/PartService.min").PartService,authService=require("./routes/AuthenticationService.min").AuthenticationService,fs=require("fs"),config=require("./config.json");var app=express();app.set("port",process.env.PORT||3e3),app.set("views",__dirname+"/views"),app.set("view engine","hjs"),app.use(express.favicon()),app.use(express.logger("dev")),app.use(express.bodyParser()),app.use(express.methodOverride()),app.use(app.router),app.use(express.static(path.join(__dirname,"public"))),"development"===app.get("env")&&app.use(express.errorHandler());var initService=new InitService(config.db.host,config.db.port,config.db.schema);initService.db(function(e,r){this.manufactureService=new ManufactureService(r),this.modelService=new ModelService(r),this.serviceTypeService=new ServiceTypeService(r),this.jobService=new JobService(r),this.manualService=new ManualService(r),this.taskService=new TaskService(r),this.idGenerationService=new IDGenerationService(r),this.jobcardService=new JobCardService(r),this.partService=new PartService(r),this.authService=new AuthenticationService(r)});var varManufacturers=null,varModels=null,varServiceTypes=null,varJobs=null,varTasks=null,varJobCards=null,makeModelMap={},varTasksMap={};app.get("/",function(e,r){manufactureService.findAll(function(e,r){varManufacturers=r}),modelService.findAll(function(e,r){makeModelMap={},varModels=r;for(var t=0;t<r.length;t++){var a=r[t].make,n=r[t].name;makeModelMap[a]=void 0==makeModelMap[a]?n:makeModelMap[a]+"#"+n}}),serviceTypeService.findAll(function(e,r){varServiceTypes=r}),jobService.findAll(function(e,t){varJobs=t,r.render("index",{title:"Jobs",jobs:t,manufacturers:varManufacturers,models:varModels,serviceTypes:varServiceTypes,makeModelMap:JSON.stringify(makeModelMap)})}),taskService.findAll(function(e,r){varTasks=r}),jobcardService.findAll(function(e,r){varJobCards=r}),taskService.findAll(function(e,r){varTasks=r;for(var t=0;t<r.length;t++){var a=r[t];varTasksMap[a.id]=a.name}})}),app.post("/manufacturer/save",function(e,r){var t=e.body.id,a=e.body.name,n=e.body.description;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),manufactureService.save({id:t,name:a,description:n},function(){r.redirect("/manufacturer")})):manufactureService.update({id:t,name:a,description:n},function(){r.redirect("/manufacturer")})}),app.get("/manufacturer",function(e,r){authenticate(),manufactureService.findAll(function(e,t){varManufacturers=t,r.render("index",{title:"Manufacturers",manufacturers:t})})}),app.get("/manufacturer/:id",function(e,r){authenticate();var t=e.params.id;manufactureService.findOne(t,function(e,t){r.render("index",{title:"Manufacturers",manufacturer:t,manufacturers:varManufacturers})})}),app.get("/manufacturer/remove/:id",function(e,r){authenticate();var t=e.params.id;manufactureService.remove(t,function(){r.redirect("/manufacturer")})}),app.post("/model/save",function(e,r){var t=e.body.id,a=e.body.make,n=e.body.name,i=e.body.yom,o=e.body.description;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),modelService.save({id:t,make:a,name:n,description:o,yom:i},function(){r.redirect("/model")})):modelService.update({id:t,make:a,name:n,description:o,yom:i},function(){r.redirect("/model")})}),app.get("/model",function(e,r){authenticate(),modelService.findAll(function(e,t){varModels=t,makeModelMap={};for(var a=0;a<t.length;a++){var n=t[a].make,i=t[a].name;makeModelMap[n]=void 0==makeModelMap[n]?i:makeModelMap[n]+"#"+i}r.render("index",{title:"Models",models:t,manufacturers:varManufacturers})})}),app.get("/model/:id",function(e,r){authenticate();var t=e.params.id;modelService.findOne(t,function(e,t){r.render("index",{title:"Models",model:t,models:varModels,manufacturers:varManufacturers})})}),app.get("/model/remove/:id",function(e,r){authenticate();var t=e.params.id;modelService.remove(t,function(){r.redirect("/model")})}),app.post("/servicetype/save",function(e,r){var t=e.body.id,a=e.body.name,n=e.body.description;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),serviceTypeService.save({id:t,name:a,description:n},function(){r.redirect("/servicetype")})):serviceTypeService.update({id:t,name:a,description:n},function(){r.redirect("/servicetype")})}),app.get("/servicetype",function(e,r){authenticate(),serviceTypeService.findAll(function(e,t){varServiceTypes=t,r.render("index",{title:"Service Types",servicetypes:t})})}),app.get("/servicetype/:id",function(e,r){authenticate();var t=e.params.id;serviceTypeService.findOne(t,function(e,t){r.render("index",{title:"Service Types",servicetype:t,servicetypes:varServiceTypes})})}),app.get("/servicetype/remove/:id",function(e,r){authenticate();var t=e.params.id;serviceTypeService.remove(t,function(){r.redirect("/servicetype")})}),app.post("/job/save",function(e,r){var t=e.body.id,a=e.body.make,n=e.body.model,i=e.body.yom,o=e.body.rego,c=e.body.odo,d=e.body.vin,s=e.body.eno,u=e.body.jobservicetype,p=e.body.status,v=e.body.fname,m=e.body.lname,f=e.body.contact,l=e.body.addressstreet,b=e.body.addresssuburb,S=e.body.addresspostcode,h=e.body.addressstate,y=e.body.note,g=e.body.startdate,j=e.body.completedate,k=e.body.total;if("-1"==t){t=crypto.randomBytes(20).toString("hex");var M=new Date,T=getDateString(M);idGenerationService.findAll(function(e,M){var A=1,x="";if(null!=M&&1==M.length){var D=M[0];A=void 0!=D.jobnumber?parseInt(D.jobnumber)+1:1,M[0].jobnumber=A,x="J"+T+"-"+A}else x="J"+T+"-1";jobService.save({id:t,jobnumber:x,make:a,model:n,yom:i,rego:o,odo:c,vin:d,eno:s,servicetypes:u,status:p,fname:v,lname:m,contact:f,addressstreet:l,addresssuburb:b,addresspostcode:S,addressstate:h,note:y,startdate:g,completedate:j,total:k},function(){null!=M&&1==M.length?idGenerationService.update(M[0],function(){r.redirect("/job")}):idGenerationService.save({id:crypto.randomBytes(20).toString("hex"),jobnumber:A,invnumber:"1"},function(){r.redirect("/job")})})})}else jobService.update({id:t,make:a,model:n,yom:i,rego:o,odo:c,vin:d,eno:s,servicetypes:u,status:p,fname:v,lname:m,contact:f,addressstreet:l,addresssuburb:b,addresspostcode:S,addressstate:h,note:y,startdate:g,completedate:j,total:k},function(){r.redirect("/job")})}),app.get("/job",function(e,r){authenticate(),jobService.findAll(function(e,t){varJobs=t,r.render("index",{title:"Jobs",jobs:t,manufacturers:varManufacturers,models:varModels,serviceTypes:varServiceTypes,makeModelMap:JSON.stringify(makeModelMap)})})}),app.get("/job/:id",function(e,r){authenticate();var t=e.params.id;jobService.findOne(t,function(e,t){r.render("index",{title:"Jobs",jobs:varJobs,job:t,manufacturers:varManufacturers,models:varModels,serviceTypes:varServiceTypes})})}),app.get("/job/remove/:id",function(e,r){authenticate();var t=e.params.id;jobService.remove(t,function(){r.redirect("/job")})}),app.get("/search",function(e,r){authenticate();var t=e.query.keyword;jobService.search(t,function(e,t){t.toArray(function(e,t){r.render("index",{title:"Jobs Search",jobs:t,manufacturers:varManufacturers,models:varModels,serviceTypes:varServiceTypes,makeModelMap:JSON.stringify(makeModelMap)})})})}),app.get("/manual",function(e,r){authenticate(),manualService.findAll(function(e,t){r.render("index",{title:"Manuals",manuals:t,manufacturers:varManufacturers,models:varModels,makeModelMap:JSON.stringify(makeModelMap)})})}),app.post("/manual/save",function(e,r){var t=crypto.randomBytes(20).toString("hex"),a=e.body.make,n=e.body.model,i=fs.readFileSync(e.files.manualfile.path),o=e.files.manualfile.name;manualService.save({id:t,make:a,model:n,data:i,filename:o},function(){r.redirect("/manual")})}),app.get("/manual/remove/:id",function(e,r){authenticate();var t=e.params.id;manualService.remove(t,function(){r.redirect("/manual")})}),app.get("/manual/:id",function(e,r){authenticate();var t=e.params.id;manualService.findOne(t,function(e,t){var a=__dirname+"\\public\\uploads\\"+t.id+"\\"+t.filename;fs.readFile(a,function(e,a){r.setHeader("Content-disposition",'attatchment; filename="'+t.filename+'"'),r.setHeader("Content-type","application/pdf"),r.send(a)})})}),app.post("/task/save",function(e,r){var t=e.body.id,a=e.body.name,n=e.body.description;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),taskService.save({id:t,name:a,description:n},function(){r.redirect("/task")})):taskService.update({id:t,name:a,description:n},function(){r.redirect("/task")})}),app.get("/task",function(e,r){authenticate(),taskService.findAll(function(e,t){varTasks=t;for(var a=0;a<t.length;a++){var n=t[a];varTasksMap[n.id]=n.name}r.render("index",{title:"Tasks",tasks:t})})}),app.get("/task/:id",function(e,r){authenticate();var t=e.params.id;taskService.findOne(t,function(e,t){r.render("index",{title:"Tasks",task:t,tasks:varTasks})})}),app.get("/task/remove/:id",function(e,r){authenticate();var t=e.params.id;taskService.remove(t,function(){r.redirect("/task")})}),app.post("/jobcard/save",function(e,r){var t=e.body.id,a=e.body.jobnumber,n=e.body.clientrequest,i=e.body.task,o=e.body.note;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),jobcardService.save({id:t,jobnumber:a,clientrequest:n,task:i,note:o},function(){r.redirect("/jobcard")})):jobcardService.update({id:t,jobnumber:a,clientrequest:n,task:i,note:o},function(){r.redirect("/jobcard")})}),app.get("/jobcard",function(e,r){authenticate(),jobcardService.findAll(function(e,t){varJobCards=t,r.render("index",{title:"Job Card",jobcards:t,tasks:varTasks})})}),app.get("/jobcard/:id",function(e,r){authenticate();var t=e.params.id;jobcardService.findOne(t,function(e,t){r.render("index",{title:"Job Card",jobcard:t,tasks:varTasks,jobcards:varJobCards})})}),app.get("/jobcard/remove/:id",function(e,r){authenticate();var t=e.params.id;jobcardService.remove(t,function(){r.redirect("/jobcard")})}),app.get("/jobcard/search/:jobnumber",function(e,r){authenticate();var t=e.params.jobnumber;jobcardService.search(t,function(e,a){a.toArray(function(e,a){if(a.length>0){var n=a[0];void 0==n?r.render("index",{title:"Job Card",jobcard:null,jobnumberTmp:t,tasks:varTasks,jobcards:varJobCards}):r.render("index",{title:"Job Card",jobcard:n,tasks:varTasks,jobcards:varJobCards})}else r.render("index",{title:"Job Card",jobcard:null,jobnumberTmp:t,tasks:varTasks,jobcards:varJobCards})})})}),app.post("/part/save",function(e,r){var t=e.body.id,a=e.body.make,n=e.body.model,i=e.body.yom,o=e.body.name,c=e.body.description;"-1"==t?(t=crypto.randomBytes(20).toString("hex"),partService.save({id:t,make:a,model:n,yom:i,name:o,description:c},function(){r.redirect("/part")})):partService.update({id:t,make:a,model:n,yom:i,name:o,description:c},function(){r.redirect("/part")})}),app.get("/part",function(e,r){authenticate(),partService.findAll(function(e,t){varParts=t,r.render("parts",{title:"Spare parts",parts:t,manufacturers:varManufacturers,models:varModels})})}),app.get("/part/:id",function(e,r){authenticate();var t=e.params.id;partService.findOne(t,function(e,t){r.render("parts",{title:"Spare parts",part:t,manufacturers:varManufacturers,models:varModels,parts:varParts})})}),app.get("/part/remove/:id",function(e,r){authenticate();var t=e.params.id;partService.remove(t,function(){r.redirect("/part")})}),app.get("/report",function(e,r){authenticate(),r.render("report",{})}),app.get("/job/print/:id",function(e,r){authenticate();var t=e.params.id,a=new Date,n=getDateString(a);jobService.findOne(t,function(e,a){idGenerationService.findAll(function(e,i){var o=1,c="";if(null!=i&&1==i.length){var d=i[0];o=parseInt(d.invnumber)+1,i[0].invnumber=o,c="INV"+n+"-"+o}else c="INV"+n+"-1";idGenerationService.update(i[0],function(){a.invnumber=c,jobService.update(a,function(){var e="http://"+config.application.host+":"+config.application.port+"/printjob/"+t,n=a.rego;jobService.convertToPdf(n,e,function(){r.redirect("/job/download/"+n+".pdf")})})})})})}),app.get("/printjob/:id",function(e,r){authenticate();var t=e.params.id,a=new Date,n=getDescriptiveDateString(a);jobService.findOne(t,function(e,t){r.render("printjob",{job:t,timestamp:n})})}),app.get("/report/jobsummary",function(e,r){authenticate();var t=e.query.start,a=e.query.end,n=getDateString(new Date(parseInt(t))),i=getDateString(new Date(parseInt(a))),o="http://"+config.application.host+":"+config.application.port+"/jobsummary?start="+t+"&end="+a,c="job-summary-report-"+n+"-to-"+i;jobService.convertToPdf(c,o,function(){r.redirect("/job/download/"+c+".pdf")})}),app.get("/jobsummary",function(e,r){authenticate();var t=e.query.start,a=e.query.end,n=e.query.status,i={};i.start=t,i.end=a,i.status=n;var o=new Date(parseInt(t)),c=new Date(parseInt(a)),d=getDescriptiveDateString(o),s=getDescriptiveDateString(c);jobService.getJobsSummary(i,function(e,t){var a=0;void 0!=t&&null!=t&&(a=t.length);for(var n=0;a>n;n++){var i=new Date(t[n].created_at),o=getDescriptiveDateString(i);if(t[n].created_at=o,t[n].completedate.length>0){var c=new Date(t[n].completedate);t[n].completedate=getDescriptiveDateString(c)}}r.render("jobsummary",{jobs:t,start:d,end:s})})}),app.get("/jobcard/print/:id",function(e,r){authenticate();var t=e.params.id;jobcardService.findOne(t,function(e,a){var n="http://"+config.application.host+":"+config.application.port+"/jobcardprint/"+t,i=a.jobnumber+"-jobcard";jobService.convertToPdf(i,n,function(){r.redirect("/job/download/"+i+".pdf")})})}),app.get("/jobcardprint/:id",function(e,r){authenticate();var t=e.params.id,a=getDescriptiveDateString(new Date);"Background Image"!=t?jobcardService.findJobcardAndJob(t,function(e,t,n){for(var i=""+t.task,o=i.split(","),c=new Array,d=0;d<o.length;d++){var s=o[d];c.push(varTasksMap[s])}var u=null;void 0!=n.vin&&17==n.vin.length&&(u=new Array,u.push(n.vin.charAt(0)),u.push(n.vin.charAt(1)),u.push(n.vin.charAt(2)),u.push(n.vin.charAt(3)),u.push(n.vin.charAt(4)),u.push(n.vin.charAt(5)),u.push(n.vin.charAt(6)),u.push(n.vin.charAt(7)),u.push(n.vin.charAt(8)),u.push(n.vin.charAt(9)),u.push(n.vin.charAt(10)),u.push(n.vin.charAt(11)),u.push(n.vin.charAt(12)),u.push(n.vin.charAt(13)),u.push(n.vin.charAt(14)),u.push(n.vin.charAt(15)),u.push(n.vin.charAt(16))),null==u?r.render("printjobcard",{jobcard:t,job:n,dateStr:a,tasks:c}):r.render("printjobcard",{jobcard:t,job:n,dateStr:a,tasks:c,vinarr:u})}):r.redirect("/jobcard")}),app.get("/job/download/:filename",function(e,r){authenticate();var t=e.params.filename,a=__dirname+"\\public\\prints\\"+t;fs.readFile(a,function(e,a){r.setHeader("Content-disposition",'attatchment; filename="'+t+'"'),r.setHeader("Content-type","application/pdf"),r.send(a)})});var monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],server=http.createServer(app).listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))}),authenticate=function(){authService.findAll(function(e,r){var t=r[0].authkey,a=crypto.createDecipher(config.alg,config.key),n=a.update(t,"hex","utf8")+a.final("utf8");n!=config.abn&&server.listen(config.application.port,function(){throw new Error})})};app.post("/auth/save",function(){id=crypto.randomBytes(20).toString("hex");var e=config.abn,r=crypto.createCipher(config.alg,config.key),t=r.update(e,"utf8","hex")+r.final("hex");authService.save({id:id,authkey:t},function(){console.log("authentiction key is saved "+t)})}),app.get("/auth",function(e,r){r.render("auth",{title:"Auth"})});
