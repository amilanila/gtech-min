var BSON=require("mongodb").BSON,ObjectID=require("mongodb").ObjectID,fs=require("fs"),path=require("path"),childProcess=require("child_process"),phantomjs=require("phantomjs"),binPath=phantomjs.path;JobService=function(e){this.db=e},JobService.prototype.getCollection=function(e){this.db.collection("job",function(t,o){t?e(t):e(null,o)})},JobService.prototype.search=function(e,t){this.getCollection(function(o,n){var i=new RegExp(["^",e,"$"].join(""),"i");o?t(o):n.find({$or:[{fname:i},{lname:i},{rego:i},{jobnumber:i}]},function(e,o){e?t(e):t(null,o)})})},JobService.prototype.findByJobNumber=function(e,t){this.getCollection(function(o,n){o?t(o):n.find({jobnumber:e},function(e,o){e?t(e):t(null,o)})})},JobService.prototype.findAll=function(e){this.getCollection(function(t,o){t?e(t):o.find().sort({created_at:-1}).toArray(function(t,o){t?e(t):e(null,o)})})},JobService.prototype.findOne=function(e,t){this.getCollection(function(o,n){o?t(o):n.findOne({id:e},function(e,o){e?t(e):t(null,o)})})},JobService.prototype.save=function(e,t){this.getCollection(function(o,n){if(o)t(o);else{"undefined"==typeof e.length&&(e=[e]);for(var i=0;i<e.length;i++){job=e[i];var r=new Date;job.created_at=r.getTime()}n.insert(e,function(){t(null,e)})}})},JobService.prototype.update=function(e,t){this.getCollection(function(o,n){o?t(o):n.update({id:e.id},{$set:{make:e.make,model:e.model,yom:e.yom,rego:e.rego,odo:e.odo,vin:e.vin,eno:e.eno,servicetypes:e.servicetypes,status:e.status,fname:e.fname,lname:e.lname,contact:e.contact,addressstreet:e.addressstreet,addresssuburb:e.addresssuburb,addresspostcode:e.addresspostcode,addressstate:e.addressstate,note:e.note,startdate:e.startdate,completedate:e.completedate,total:e.total,invnumber:e.invnumber}},function(e,o){t(e?e:o)})})},JobService.prototype.remove=function(e,t){this.getCollection(function(o,n){o?t(o):n.remove({id:e},{justOne:!0},function(e,o){t(o)})})},JobService.prototype.getJobsSummary=function(e,t){var o=864e5,n=e.start,i=parseInt(e.end)+o,r=e.status;this.getCollection(void 0!=r&&"-"!=r?function(e,o){o.find({$and:[{created_at:{$gte:parseInt(n),$lt:parseInt(i)}},{status:r}]},function(e,o){o.toArray(function(e,o){t(null,o)})})}:function(e,o){o.find({created_at:{$gte:parseInt(n),$lt:parseInt(i)}},function(e,o){o.toArray(function(e,o){t(null,o)})})})},JobService.prototype.convertToPdf=function(e,t,o){var n=[path.join(__dirname,"PrintService.js"),e,t];childProcess.execFile(binPath,n,function(){o()})},exports.JobService=JobService;
